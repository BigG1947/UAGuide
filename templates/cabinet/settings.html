<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>UA Guide - Налаштування</title>
    <!-- MDB icon -->
    <link rel="icon" href="/static/img/svg/search-solid.svg" type="image/x-icon">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <!-- Material Design Bootstrap -->
    <link rel="stylesheet" href="/static/css/mdb.min.css">
    <!-- Your custom styles (optional) -->
    <link rel="stylesheet" href="/static/css/cropper/cropper.css">
    <link rel="stylesheet" href="/static/css/cabinet.css">
</head>
<body>

<!-- Main navigation -->
<header style="height: auto">
    <!--Navbar-->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/"><strong><span class="blue-text">U</span><span class="yellow-text">A</span>
                    Guide</strong></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent-7"
                    aria-controls="navbarSupportedContent-7" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent-7">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Головна </a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/cabinet">Кабінет<span class="sr-only">(current)</span></a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Navbar -->
</header>
<!-- Main navigation -->

<!-- Position it -->
<div style="position: absolute; bottom: 20px; right: 0; z-index: 999">

    <!-- Then put toasts within -->
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="mr-auto">UAGuide</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="toast-body" id="toast-body">
        </div>
    </div>

</div>

<!-- Content -->
<main class="container mt-5 pt-5 pb-5" style="min-height: 100vh">

    <div class="row">
        <!-- Left side -->
        <div class="col-12 col-md-5 col-lg-4">
            <!-- User Card -->
            <div class="card user-info-card p-4">
                <div class="card-header rounded rounded-circle p-0">
                    <img src="{{.user.Photo}}" class="card-img img-fluid rounded rounded-circle" alt="">
                </div>
                <div class="mt-3">
                    <h2 class="font-weight-bold text-center dark-blue roboto-fonts" style="font-size: 1.1rem">{{.user.FIO}}</h2>
                </div>
                <hr class="hr my-3">
                <div class="card-body p-0">
                    <ul class="w-100 list-unstyled roboto-fonts" style="font-size: 1rem; font-weight: 500">
                        <li class="list-item"><i class="fa fa-phone prefix grey-text mb-2 mr-2"
                                                 style="font-size: 1.1em"></i>{{.user.Phone}}
                        </li>
                        <li class="list-item"><i class="fa fa-envelope prefix grey-text mr-2 my-2"
                                                 style="font-size: 1.1em"></i>{{.user.Email}}
                        </li>
                    </ul>
                    <div>
                        <a href="/cabinet" class="btn btn-outline-grey btn-sm">повернутися до кабінету</a>
                    </div>
                </div>
            </div>
            <!-- /User Card -->
        </div>
        <!-- /Left side -->

        <!-- Right side -->
        <div class="col-12 col-md-7 col-lg-8 my-3 my-md-0">

            <div class="card px-5 py-3">
                <h3 class="grey-text h3-responsive my-3 text-center">Особиста інформація</h3>
                <form action="" id="personal_data_form" method="post" enctype="multipart/form-data">
                    {{ if not (eq (len .successMessage) 0) }}
                        <div class="alert alert-arrow alert-arrow d-flex rounded p-0" role="alert">
                            <div class="alert-icon d-flex justify-content-center align-items-center text-white flex-grow-0 flex-shrink-0">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="alert-message d-flex align-items-center py-2 pl-4 pr-3">
                                {{ .successMessage }}
                            </div>
                            <a href="#" class="close d-flex ml-auto justify-content-center align-items-center px-3" data-dismiss="alert">
                                <i class="fas fa-times"></i>
                            </a>
                        </div>
                    {{ end }}
                    <div class="row">
                        <div class="col-12">
                            <div class="md-form">
                                <i class="fa fa-user prefix grey-text"></i>
                                <input type="text" id="fio" name="fio" class="form-control">
                                <label for="fio">Прізвище та Ім'я</label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-md-6">
                            <div class="md-form">
                                <i class="fas fa-phone prefix grey-text"></i>
                                <input
                                       pattern="^((8|\+3)[\- ]?)?(\(?\d{3}\)?[\- ]?)?[\d\- ]{7,10}$"
                                       type="tel" name="phone" id="phone" class="form-control">
                                <label for="phone">Ваш телефон</label>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="md-form">
                                <i class="fa fa-envelope prefix grey-text"></i>
                                <input type="email" name="email" id="email" class="form-control">
                                <label for="email">Ваша почта</label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-md-6">
                            <div class="md-form">
                                <button type="button" id="photo_btn" class="btn btn-outline-grey btn-sm"
                                        style="display: flex; align-items: center"><i
                                            class="fas fa-camera grey-text mr-2" style="font-size: 1.5rem;"></i>Завантажити
                                    світлину
                                </button>
                                <small class="small grey-text">* Якщо ви бажаєте залишити стару інформацію залиште поле
                                    пустим</small>
                                <input accept=".jpg, .jpeg, .png" type="file" id="photo" hidden>
                                <input type="text" hidden name="photo">
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <img class="rounded rounded-circle" style="width: 13rem; margin: auto" src=""
                                 id="cropper_img">
                        </div>
                    </div>
                    <div class="row mx-1 justify-content-end">
                        <button class="btn btn-outline-dark-green btn-sm">зберегти зміни</button>
                    </div>
                </form>
            </div>

        </div>

        <!-- /Right side -->
    </div>

</main>
<!-- Content -->

<div class="container">
    <div id="modal_cropper" class="modal fade roboto-fonts" tabindex="-1" role="dialog"
         aria-labelledby="cropper_modal_label" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" style="overflow: hidden">
                <div class="modal-body mr-4">
                    <img class="img-fluid w-100" src="" id="img_for_cropper">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-dark-danger" data-dismiss="modal">Відмінити</button>
                    <button type="button" id="modal_cropper_btn_success" class="btn btn-outline-grey">Зберегти</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Footer -->
<footer class="page-footer font-small blue-grey darken-4 py-4">

    <!-- Footer Elements -->
    <div class="container">

        <div class="row">
            <div class="col-6 d-flex justify-content-start">
                <!-- Copyright -->
                <div class="footer-copyright text-center bg-transparent">© 2019 Copyright:
                    <a href="https://mdbootstrap.com/education/bootstrap/"> UA Guide</a>
                </div>
                <!-- Copyright -->
            </div>
            <div class="col-6 d-flex justify-content-end">
                <ul class="list-unstyled d-flex mb-0">
                    <li>
                        <a class="mr-3" role="button"><i class="fab fa-facebook-f"></i></a>
                    </li>
                    <li>
                        <a class="mr-3" role="button"><i class="fab fa-twitter"></i></a>
                    </li>
                    <li>
                        <a class="mr-3" role="button"><i class="fab fa-instagram"></i></a>
                    </li>
                    <li>
                        <a class="" role="button"><i class="fab fa-youtube"></i></a>
                    </li>
                </ul>
            </div>
        </div>

    </div>
    <!-- Footer Elements -->

</footer>
<!-- Footer -->

<!-- jQuery -->
<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<!-- Bootstrap tooltips -->
<script type="text/javascript" src="/static/js/popper.min.js"></script>
<!-- Bootstrap core JavaScript -->
<script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
<!-- MDB core JavaScript -->
<script type="text/javascript" src="/static/js/mdb.min.js"></script>
<!-- Your custom scripts (optional) -->
<script src="/static/js/cropper/cropper.js"></script>
<script type="text/javascript">
    new WOW().init();

    let photoBtn = document.querySelector("#photo_btn");
    let photoInput = document.querySelector('#photo');
    let photoSrcInput = document.querySelector('[name=photo]');

    let cropperDiv = document.querySelector("#cropper_img");
    let imgCropperDiv = document.querySelector("#img_for_cropper");

    let modalDiv = document.querySelector('#modal_cropper');
    let modal_cropper_btn_success = document.querySelector('#modal_cropper_btn_success');

    let cropper;
    let img;
    let uploadStatus = false;

    let toastBody = document.querySelector("#toast-body");
    $('.toast').toast({delay: 5000});


    photoBtn.addEventListener("click", function (event) {
        photoInput.click();
    });

    photoInput.addEventListener('input', function (event) {
        let file = event.target.files[0];
        if (file) {
            console.log("success");
            imgCropperDiv.src = window.URL.createObjectURL(file);
            $(modalDiv).modal();
        }
        console.log(event.target.files);
    });

    $(modalDiv).on("shown.bs.modal", function () {
        cropper = new Cropper(imgCropperDiv, {
            aspectRatio: 1
        });
        cropper.element.width = '100%';
    });

    modal_cropper_btn_success.addEventListener('click', function (event) {
        cropper.getCroppedCanvas().toBlob(function (blob) {
            img = blob;
            cropperDiv.src = URL.createObjectURL(img);
            imgCropperDiv.scr = '';
            $(modalDiv).modal('hide');
        }, 'image/jpeg', 1);
    });

    $(modalDiv).on("hide.bs.modal", function () {
        photoInput.value = '';
        cropper.destroy();
    });

    form = document.querySelector("#personal_data_form");
    form.addEventListener('submit', function (event) {
        if (img) {
            if (uploadStatus === false){
                event.preventDefault();
            }else{
                return
            }
            let xhr = new XMLHttpRequest();
            xhr.responseType = 'json';
            xhr.open("POST", "/api/uploadImages");
            xhr.withCredentials = true;
            xhr.send(img);
            xhr.onload = function () {
                if (xhr.status != 200) {
                    console.log(xhr.response);
                    toastBody.innerHTML = 'Невідома помилка. Спробуйте пізніше ще раз';
                    $('.toast').toast('show');
                } else {
                    uploadStatus = true;
                    console.log(xhr);
                    photoSrcInput.value = xhr.response.src;
                    form.submit();
                }
            };
        }
    });

    let phoneInput = document.querySelector("#phone");
    phoneInput.addEventListener("change", function (e) {
        var xhr = new XMLHttpRequest();
        var body = phoneInput.value;
        xhr.open("POST", '/api/checkPhone', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.responseType = "json";
        xhr.onload = function () {
            if (xhr.status != 200) {
                toastBody.innerHTML = 'Невідома помилка. Спробуйте пізніше ще раз';
                $('.toast').toast('show');
                phoneInput.setCustomValidity("Невідома помилка. Спробуйте пізніше ще раз");
            } else {
                if (xhr.response.ok === "false") {
                    phoneInput.setCustomValidity("Номер телефону вже використовується!");
                } else {
                    phoneInput.setCustomValidity('');
                }
            }
        };
        xhr.send(body);
    });

    let emailInput = document.querySelector("#email");
    emailInput.addEventListener("change", function (e) {
        var xhr = new XMLHttpRequest();
        var body = emailInput.value;
        xhr.open("POST", '/api/checkEmail', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.responseType = "json";
        xhr.onload = function () {
            if (xhr.status != 200) {
                toastBody.innerHTML = 'Невідома помилка. Спробуйте пізніше ще раз';
                $('.toast').toast('show');
                emailInput.setCustomValidity('Невідома помилка. Спробуйте пізніше ще раз');
            } else {
                if (xhr.response.ok === "false") {
                    emailInput.setCustomValidity("Поштова адреса вже використовується!");
                } else {
                    emailInput.setCustomValidity('');
                }
            }
        };
        xhr.send(body);
    });


</script>

</body>
</html>




